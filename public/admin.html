<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel ‚Äì Diesel Designs</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <nav class="container-fluid">
    <ul><li><strong>Diesel Designs</strong></li></ul>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="#" role="button">Admin</a></li>
    </ul>
  </nav>

  <main class="container">
    <div class="grid">
      <section>
        <hgroup>
          <h2>Admin Panel</h2>
          <h3>Edit Form Questions & Agreement</h3>
        </hgroup>

        <h3>Questions</h3>
        <ul id="question-list"></ul>
        <button onclick="addQuestion()">+ Add Question</button>
        <button onclick="saveQuestions()">üíæ Save Questions</button>

        <hr />

        <h3>Agreement Text</h3>
        <textarea id="agreement-text" rows="10" placeholder="Loading agreement..."></textarea>
        <button onclick="saveAgreement()">üíæ Save Agreement</button>
      </section>
    </div>
  </main>

  <script>
    let questions = [];

    async function fetchQuestions() {
      try {
        const res = await fetch('/admin/questions');
        questions = await res.json();
        renderQuestions();
      } catch (err) {
        alert('‚ùå Error loading questions');
      }
    }

    function renderQuestions() {
      const list = document.getElementById('question-list');
      list.innerHTML = '';

      questions.forEach((q, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <input type="text" placeholder="Label" value="${q.label || ''}" onchange="questions[${i}].label = this.value" />
          <input type="text" placeholder="Name" value="${q.name || ''}" onchange="questions[${i}].name = this.value" />
          <select onchange="questions[${i}].type = this.value">
            <option value="text" ${q.type === 'text' ? 'selected' : ''}>Text</option>
            <option value="textarea" ${q.type === 'textarea' ? 'selected' : ''}>Textarea</option>
            <option value="checkbox" ${q.type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
            <option value="file" ${q.type === 'file' ? 'selected' : ''}>File Upload</option>
          </select>
          <label>
            Required?
            <input type="checkbox" ${q.required ? 'checked' : ''} onchange="questions[${i}].required = this.checked" />
          </label>
          <button onclick="removeQuestion(${i})">üóëÔ∏è</button>
        `;
        list.appendChild(li);
      });
    }

    function addQuestion() {
      questions.push({ label: '', name: '', type: 'text', required: false });
      renderQuestions();
    }

    function removeQuestion(index) {
      questions.splice(index, 1);
      renderQuestions();
    }

    async function saveQuestions() {
      try {
        await fetch('/admin/questions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(questions)
        });
        alert('‚úÖ Questions saved!');
      } catch (err) {
        alert('‚ùå Failed to save questions');
      }
    }

    async function fetchAgreement() {
      try {
        const res = await fetch('/admin/agreement');
        const text = await res.text();
        document.getElementById('agreement-text').value = text;
      } catch {
        alert('‚ùå Error loading agreement');
      }
    }

    async function saveAgreement() {
      const text = document.getElementById('agreement-text').value;
      try {
        await fetch('/admin/agreement', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        alert('‚úÖ Agreement saved!');
      } catch {
        alert('‚ùå Failed to save agreement');
      }
    }

    // Init
    fetchQuestions();
    fetchAgreement();
  </script>
</body>
</html>
